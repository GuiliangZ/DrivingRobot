import numpy as np
from DeePCAcados import deepctools
from io import StringIO

# # Provided data
# y_ref = np.array([[1.57135583], [1.75267947], [2.12267916], [2.49267886],
#                   [2.86267855], [3.23267825], [3.60267794], [3.97267763],
#                   [4.34267733], [4.71267702]])
# u_init = np.array([[3.14127393], [3.70751186], [4.27173751], [4.7115057],
#                    [5.43398508], [6.22166757], [6.8428528], [7.3194446],
#                    [7.54212862], [7.72124038]])
# y_init = np.array([[0.10590856], [0.16329333], [0.22856726], [0.3000026],
#                    [0.3933475], [0.50555825], [0.64630991], [0.81505454],
#                    [1.00949609], [1.22265458]])
y_ref = np.array([
    [1.40145572],
    [1.55145560],
    [1.70359224],
    [2.07359193],
    [2.44359162],
    [2.81359132],
    [3.18359101],
    [3.55359071],
    [3.92359040],
    [4.29359009],
])

y_init = np.array([
    [0.13891093],
    [0.22839049],
    [0.32750151],
    [0.43277410],
    [0.54737902],
    [0.66988981],
    [0.78764516],
    [0.90989447],
    [1.03783810],
    [1.18059587],
])

u_init = np.array([
    [2.38229954],
    [2.29999397],
    [2.62145372],
    [2.90439933],
    [3.12790499],
    [3.60791053],
    [4.35945210],
    [5.09970645],
    [5.78668544],
    [6.38402257],
])


Up = np.array([
    [1.85636444, 1.68071803, 1.81883229, 1.91042948, 1.99965648, 2.44367686, 3.18803885, 3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573],
    [1.68071803, 1.81883229, 1.91042948, 1.99965648, 2.44367686, 3.18803885, 3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659],
    [1.81883229, 1.91042948, 1.99965648, 2.44367686, 3.18803885, 3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190],
    [1.91042948, 1.99965648, 2.44367686, 3.18803885, 3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869],
    [1.99965648, 2.44367686, 3.18803885, 3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191],
    [2.44367686, 3.18803885, 3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042],
    [3.18803885, 3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623],
    [3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586],
    [4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857],
    [5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154]
])

Up_cur = np.array([
    [1.85636444, 1.68071803, 1.81883229, 1.91042948, 1.99965648, 2.44367686, 3.18803885, 3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573],
    [1.68071803, 1.81883229, 1.91042948, 1.99965648, 2.44367686, 3.18803885, 3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659],
    [1.81883229, 1.91042948, 1.99965648, 2.44367686, 3.18803885, 3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190],
    [1.91042948, 1.99965648, 2.44367686, 3.18803885, 3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869],
    [1.99965648, 2.44367686, 3.18803885, 3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191],
    [2.44367686, 3.18803885, 3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042],
    [3.18803885, 3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623],
    [3.97239561, 4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586],
    [4.76657671, 5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857],
    [5.49182295, 6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154]
])

Uf = np.array([
    [6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588],
    [6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694],
    [7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255],
    [8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255, 14.87848279],
    [9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255, 14.87848279, 14.65862101],
    [9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255, 14.87848279, 14.65862101, 14.63989430],
    [9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255, 14.87848279, 14.65862101, 14.63989430, 14.81173110],
    [9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255, 14.87848279, 14.65862101, 14.63989430, 14.81173110, 15.12856053],
    [9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255, 14.87848279, 14.65862101, 14.63989430, 14.81173110, 15.12856053, 15.57785657],
    [9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255, 14.87848279, 14.65862101, 14.63989430, 14.81173110, 15.12856053, 15.57785657, 16.17658189]
])

Uf_cur = np.array([
    [6.06824353, 6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588],
    [6.52020622, 7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694],
    [7.59274775, 8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255],
    [8.53315335, 9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255, 14.87848279],
    [9.36044183, 9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255, 14.87848279, 14.65862101],
    [9.73648800, 9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255, 14.87848279, 14.65862101, 14.63989430],
    [9.59629055, 9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255, 14.87848279, 14.65862101, 14.63989430, 14.81173110],
    [9.20320387, 9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255, 14.87848279, 14.65862101, 14.63989430, 14.81173110, 15.12856053],
    [9.28565083, 9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255, 14.87848279, 14.65862101, 14.63989430, 14.81173110, 15.12856053, 15.57785657],
    [9.46839780, 9.77768573, 10.14081659, 11.00064190, 12.00231869, 13.10266191, 14.03813042, 14.73215623, 15.22487586, 15.53524857, 15.68025154, 15.73051588, 15.70662694, 15.23550255, 14.87848279, 14.65862101, 14.63989430, 14.81173110, 15.12856053, 15.57785657, 16.17658189]
])


Yp = np.array([
    [0.22330715, 0.32645744, 0.45268571, 0.58691472, 0.72143167, 0.84865957, 0.96700639, 1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932],
    [0.32645744, 0.45268571, 0.58691472, 0.72143167, 0.84865957, 0.96700639, 1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924],
    [0.45268571, 0.58691472, 0.72143167, 0.84865957, 0.96700639, 1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326],
    [0.58691472, 0.72143167, 0.84865957, 0.96700639, 1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527],
    [0.72143167, 0.84865957, 0.96700639, 1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666],
    [0.84865957, 0.96700639, 1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121],
    [0.96700639, 1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984],
    [1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268],
    [1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775],
    [1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410]
])

Yp_cur = np.array([
    [0.22330715, 0.32645744, 0.45268571, 0.58691472, 0.72143167, 0.84865957, 0.96700639, 1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932],
    [0.32645744, 0.45268571, 0.58691472, 0.72143167, 0.84865957, 0.96700639, 1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924],
    [0.45268571, 0.58691472, 0.72143167, 0.84865957, 0.96700639, 1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326],
    [0.58691472, 0.72143167, 0.84865957, 0.96700639, 1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527],
    [0.72143167, 0.84865957, 0.96700639, 1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666],
    [0.84865957, 0.96700639, 1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121],
    [0.96700639, 1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984],
    [1.07941043, 1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268],
    [1.19082785, 1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775],
    [1.31374657, 1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410]
])

Yf = np.array([
    [1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129],
    [1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191],
    [1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274],
    [2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274, 9.07184124],
    [2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274, 9.07184124, 9.45469570],
    [2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274, 9.07184124, 9.45469570, 9.81338501],
    [2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274, 9.07184124, 9.45469570, 9.81338501, 10.14771652],
    [3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274, 9.07184124, 9.45469570, 9.81338501, 10.14771652, 10.45838928],
    [3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274, 9.07184124, 9.45469570, 9.81338501, 10.14771652, 10.45838928, 10.74688530],
    [4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274, 9.07184124, 9.45469570, 9.81338501, 10.14771652, 10.45838928, 10.74688530, 11.01145744]
])

Yf_cur = np.array([
    [1.46067071, 1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129],
    [1.63506722, 1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191],
    [1.83841014, 2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274],
    [2.06521487, 2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274, 9.07184124],
    [2.31223559, 2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274, 9.07184124, 9.45469570],
    [2.58966541, 2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274, 9.07184124, 9.45469570, 9.81338501],
    [2.90534735, 3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274, 9.07184124, 9.45469570, 9.81338501, 10.14771652],
    [3.25503039, 3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274, 9.07184124, 9.45469570, 9.81338501, 10.14771652, 10.45838928],
    [3.62881422, 4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274, 9.07184124, 9.45469570, 9.81338501, 10.14771652, 10.45838928, 10.74688530],
    [4.00521183, 4.36009932, 4.70940924, 5.02628326, 5.32200527, 5.60392666, 5.89485121, 6.21125984, 6.56588268, 6.95058775, 7.36573410, 7.79730129, 8.23631191, 8.66459274, 9.07184124, 9.45469570, 9.81338501, 10.14771652, 10.45838928, 10.74688530, 11.01145744]
])

g_prev = np.array([
    -0.67287496,  0.16449661,  0.04380181,  0.16449672,  0.03165669,
     0.16449643,  0.00340351,  0.16449701, -0.00301640,  0.16449683,
     0.00553235,  0.00000000, -0.04662344,  0.00000000, -0.14956291,
     0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,
     0.00000000
])


# DeePC parameters
u_dim = 1
y_dim = 1
T = 40
Tini = 10
THorizon = 10
Q_val = 4000
R_val = 1
lambda_g_val = 50
lambda_y_val = 10
lambda_u_val = 10
Q = np.diag(np.tile(Q_val, THorizon))
R = np.diag(np.tile(R_val, THorizon))
lambda_g = np.diag(np.tile(lambda_g_val, T - Tini - THorizon + 1))
lambda_y = np.diag(np.tile(lambda_y_val, Tini))
lambda_u = np.diag(np.tile(lambda_u_val, Tini))
ineqconidx = {'u': list(range(u_dim)), 'y': list(range(y_dim))}
ineqconbd = {
    'lbu': np.tile([-30], Tini),  # Apply -30 to all u steps
    'ubu': np.tile([100], Tini),  # Apply 100 to all u steps
    'lby': np.tile([0], Tini),    # Apply 0 to all y steps
    'uby': np.tile([140], Tini),  # Apply 140 to all y steps
    # 'lbdu': np.tile([-10], Tini), # Add Delta u constraints
    # 'ubdu': np.tile([10], Tini)   # Add Delta u constraints
}

# Initialize DeePC
dpc = deepctools(u_dim, y_dim, T, Tini, THorizon, ineqconidx=ineqconidx, ineqconbd=ineqconbd)
dpc.init_DeePCAcadosSolver(recompile_solver=False)

# Solve
u_opt, g_opt, t_deepc, exist_feasible_sol = dpc.acados_solver_step(
    uini=u_init, yini=y_init, yref=y_ref, Up_cur=Up_cur, Uf_cur=Uf_cur,
    Yp_cur=Yp_cur, Yf_cur=Yf_cur, Q_val=Q, R_val=R, lambda_g_val=lambda_g,
    lambda_y_val=lambda_y, lambda_u_val=lambda_u, g_prev=g_prev)
print(f"u_opt: {u_opt}, g_opt: {g_opt}, feasible: {exist_feasible_sol}")

A_weighted = np.vstack([np.sqrt(lambda_u_val) * Up, np.sqrt(lambda_y_val) * Yp])
cond_A = np.linalg.cond(A_weighted)
print(f"Condition number of A_weighted: {cond_A}")

H = Yf.T @ Q @ Yf + Uf.T @ R @ Uf + Yp.T @ lambda_y @ Yp + Up.T @ lambda_u @ Up + lambda_g
cond_H = np.linalg.cond(H)
print(f"Condition number of Hessian: {cond_H}")